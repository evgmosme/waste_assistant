# GitHub Actions workflow:
# Builds the repo’s Docker image with Cloud Build
# and deploys it as a new revision of the existing
# Cloud Run service “wasteassistant”.

name: Build & Deploy to Cloud Run

# ─── Triggers ───────────────────────────────────────────────────────────
on:
  push:                  # run on every push to main
    branches: ["main"]
  workflow_dispatch:     # manual “Run workflow” button

# ─── Single job ────────────────────────────────────────────────────────
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest         # use the hosted GitHub runner

    steps:
    # 1️⃣ Check out the repository at this commit
    - name: Checkout source
      uses: actions/checkout@v4

    # 2️⃣ Authenticate the runner to GCP using the service-account key
    #     stored in the repository secret GCP_SA_KEY.
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    # 3️⃣ Build the image from the repo root and deploy it
    #     Cloud Build is invoked under the hood by “source: .”.
    #     The env_vars section passes runtime secrets to the container.
    - name: Deploy to Cloud Run
      uses: google-github-actions/deploy-cloudrun@v2
      with:
        service: wasteassistant          # existing Cloud Run service
        source: .                        # buildpacks build from repo root
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        region: ${{ secrets.GCP_REGION }}
        env_vars: |
          api_key=${{ secrets.OPENAI_API_KEY }}
          secret_key=${{ secrets.FLASK_SECRET }}
        flags: --allow-unauthenticated   # keep the public URL accessible
